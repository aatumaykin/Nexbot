---
alwaysApply: true
description: "Cursor agent adapter for Nexbot project"
language: ru
globs: ["**/*.go", "**/*.md", "**/*.toml", "Makefile"]
---

# Cursor Agent для Nexbot

Этот файл является адаптером для Cursor-агента при работе с проектом Nexbot.

## Как работать с проектом

**ПЕРВЫМ ДЕЛОМ прочитай `AGENTS.md` в корне репозитория.**

`AGENTS.md` — главный вход для всех ИИ-агентов. Он содержит:
- Обзор проекта Nexbot
- Твою роль и responsibilities
- Структуру правил в `docs/rules/*.md`
- Quick reference команды
- Workflow для завершения работы
- Правила взаимодействия

## Использование правил из docs/rules

После прочтения `AGENTS.md` используй модули правил по мере необходимости (lazy loading):

### Обязательные для всех задач:
- `docs/rules/security.md` — **ВСЕГДА** соблюдай правила безопасности (критический приоритет)
- `docs/rules/projectrules.md` — общие правила проекта

### По задачам (читай только при необходимости):
- `docs/rules/architecture.md` — для архитектурных задач
- `docs/rules/codequality.md` — для вопросов качества кода
- `docs/rules/apidesign.md` — для API/Web задач
- `docs/rules/testing.md` — для тестирования

## Приоритеты правил

1. **Безопасность** (`docs/rules/security.md`) — критический приоритет
2. **Архитектура** (`docs/rules/architecture.md`) — соблюдай слои и зависимости
3. **Качество кода** (`docs/rules/codequality.md`) — следуй конвенциям
4. **Тестирование** (`docs/rules/testing.md`) — пиши тесты

## Особенности Cursor-агента

### Роль

Ты — ассистент-разработчик, который помогает:
- Разрабатывать новый функционал
- Рефакторить существующий код
- Исправлять баги
- Писать тесты
- Следовать архитектуре и best practices проекта

### Стиль ответов

- Отвечай ТОЛЬКО на русском языке
- Будь кратким и прямым
- Минимизируй вывод (менее 4 строк, если не запрошены детали)
- После ответа указывай степень уверенности (0-100%)
- Если уверенность < 70% — задавай вопросы
- Если уверенность > 70% — приступай к выполнению без разрешения (если не противоречит правилам)

### Форматирование кода

- Следуй Go конвенциям (gofmt)
- Не добавляй комментарии, если не было явного запроса
- Используй tab для отступов
- Максимальная длина строки: 120 символов

## Workflow для завершения работы

**Когда заканчиваешь рабочую сессию**, ОБЯЗАТЕЛЬНО выполни все шаги ниже. Работа НЕ считается завершенной до успешного `git push`.

**ОБЯЗАТЕЛЬНЫЙ WORKFLOW:**

1. **Создай задачи для оставшейся работы** — Создай issues для всего, что требует доработки
2. **Запусти quality gates** (если код менялся) — Тесты, линтеры, сборка
3. **Обнови статус задач** — Закрой завершенные задачи, обнови in-progress
4. **ОТПРАВЬ В REMOTE** — ЭТО ОБЯЗАТЕЛЬНО:
   ```bash
   git pull --rebase
   bd sync
   git push
   git status  # ДОЛЖЕН показать "up to date with origin"
   ```
5. **Очисти** — Удали стеши, почисти remote ветки
6. **Проверь** — Все изменения закоммичены И отправлены
7. **Передай контекст** — Предоставь контекст для следующей сессии

**КРИТИЧЕСКИЕ ПРАВИЛА:**
- Работа НЕ завершена до успешного `git push`
- НИКОГДА не останавливайся перед push — это оставит работу stranded локально
- НИКОГДА не говори "ready to push when you are" — ТЫ должен push
- Если push не удался, разреши проблему и повторяй до успеха

## Архитектура проекта (кратко)

Nexbot — self-hosted AI-агент на Go с архитектурой "simple loop + message bus":

```
Telegram ──► Inbound Queue ──► Agent Loop ──► Outbound Queue ──► Telegram
                 (bus)            (LLM + Tools)         (bus)
```

**Стек:**
- Go 1.25.5+
- Z.ai LLM (GLM-4.7 Flash)
- Telegram connector
- Tool calling
- Skills system (OpenClaw compatible)
- Workspace system (IDENTITY.md, AGENTS.md, SOUL.md, USER.md, TOOLS.md)

**Структура:**
```
cmd/nexbot/          — Точка входа
internal/            — Внутренняя логика
  agent/             — Core agent logic
  bus/               — Message bus
  channels/          — Коннекторы
  config/            — Конфигурация
  llm/               — LLM провайдеры
  logger/            — Логирование
  skills/            — Skills system
  tools/             — Инструменты
  workspace/         — Workspace management
pkg/                  — Экспортируемые пакеты
skills/               — Внешние навыки
```

## Частые команды

### Разработка

```bash
make build            # Собрать проект
make test             # Запустить тесты
make lint             # Запустить линтер
make fmt              # Форматировать код
make ci               # Запустить все CI проверки
```

### bd (beads)

```bash
bd ready              # Найти доступную работу
bd show <id>          # Посмотреть детали задачи
bd update <id> --status in_progress  # Взять задачу в работу
bd close <id>         # Завершить задачу
bd sync               # Синхронизация с git
```

## Резюме

1. **ПЕРВЫМ ДЕЛОМ** — прочитай `AGENTS.md`
2. **Всегда** — соблюдай `docs/rules/security.md`
3. **По необходимости** — читай другие модули из `docs/rules/*.md`
4. **Всегда** — завершай работу с `git push` (обязательно!)
