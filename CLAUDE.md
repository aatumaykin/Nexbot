# Инструкции для Claude

Этот файл определяет профиль и поведение Claude при работе с проектом Nexbot.

## Базовый источник правил

Claude должен следовать инструкциям из `AGENTS.md` в корне репозитория как основному источнику правил.

**Прочитай сначала:**
1. `AGENTS.md` — главный вход и инструкции
2. `docs/rules/security.md` — правила безопасности (критический приоритет)
3. `docs/rules/projectrules.md` — общие правила проекта

**Затем по необходимости (lazy loading):**
- `docs/rules/architecture.md` — архитектурные задачи
- `docs/rules/codequality.md` — качество кода
- `docs/rules/apidesign.md` — API/Web задачи
- `docs/rules/testing.md` — тестирование

## Особенности Claude

### Стиль и формат ответов

- Отвечай ТОЛЬКО на русском языке
- Будь кратким и прямым (минимум преамбулы и постамбулы)
- Используй GitHub-flavored markdown для форматирования
- Избегай эмодзи, если пользователь не запросил их явно
- После ответа указывай степень уверенности (0-100%)

### Интерпретация приоритетов правил

Claude должен интерпретировать приоритеты правил следующим образом:

1. **Безопасность** (`docs/rules/security.md`) — критический приоритет
   - Никогда не хардкоди секреты
   - Всегда маскируй секреты в логах
   - Используй переменные окружения для чувствительных данных
   - Если есть конфликт между безопасностью и удобством — выбирай безопасность

2. **Архитектура** (`docs/rules/architecture.md`) — высокий приоритет
   - Соблюдай слои и направление зависимостей
   - Не создавай циклических зависимостей
   - Следуй паттернам проекта

3. **Качество кода** (`docs/rules/codequality.md`) — средний приоритет
   - Следуй конвенциям именования
   - Пиши Clean Code (DRY, SOLID, KISS, YAGNI)
   - Используй structured logging

4. **Тестирование** (`docs/rules/testing.md`) — обязательное требование
   - Пиши unit тесты для нового кода
   - Тестируй edge cases и error handling
   - Цель покрытия: >70%

### Обработка конфликтов правил

Если есть конфликт между правилами:

1. Безопасность > Архитектура > Качество кода > Удобство
2. Если не уверен — спроси пользователя
3. Предоставь несколько вариантов решений с плюсами/минусами

## Рекомендуемый workflow

### Для архитектурных задач

1. Прочитай `docs/rules/architecture.md`
2. Изучи существующие компоненты
3. Предложи решение, следующее архитектуре проекта
4. Объясни почему это решение подходит

### Для разработки нового функционала

1. Прочитай `docs/rules/projectrules.md` и `docs/rules/codequality.md`
2. Проверь `docs/rules/architecture.md` для понимания слоев
3. Изучи похожий код в проекте
4. Реализуй по паттернам проекта
5. Напиши тесты

### Для багфикса

1. Воспроизведи проблему
2. Найди корневую причину
3. Предложи решение
4. Напиши тесты для предотвращения регрессии
5. Примени решение
6. Запусти тесты

### Для рефакторинга

1. Прочитай `docs/rules/codequality.md`
2. Найди код, нарушающий принципы
3. Напиши тесты (если их нет)
4. Рефактори маленькими шагами
5. Запускай тесты после каждого шага

## Lazy loading

Claude должен использовать lazy loading для `docs/rules/*.md`:

- **Не читай все файлы сразу** — это избыточно
- **Читай по необходимости** — только то, что нужно для задачи
- **Начни с базовых файлов** (security.md, projectrules.md)
- **Далее читай специфичные файлы** (architecture.md, codequality.md, testing.md, apidesign.md)

Примеры:

**Задача: "Добавь новый инструмент для работы с GitHub"**
→ Читай: `docs/rules/projectrules.md`, `docs/rules/architecture.md` (tools layer)

**Задача: "Исправь уязвимость в обработке путей файлов"**
→ Читай: `docs/rules/security.md` (критично), `docs/rules/codequality.md`

**Задача: "Напиши unit тесты для agent loop"**
→ Читай: `docs/rules/testing.md`, `docs/rules/codequality.md`

**Задача: "Добавь REST API endpoint для создания сессий"**
→ Читай: `docs/rules/apidesign.md`, `docs/rules/architecture.md`

## Контекст

### При 50% заполнении контекста

Создай краткое резюме текущего состояния:

```markdown
## Резюме текущей сессии

**Цель:** <краткая цель>

**Что сделано:**
- [x] ...
- [x] ...

**Что в процессе:**
- [ ] ...

**Осталось:**
- [ ] ...

**Вопросы к пользователю:**
- ...
```

### При завершении сессии

**ОБЯЗАТЕЛЬНО** выполни "Landing the Plane" workflow из `AGENTS.md`:

1. Создай задачи для оставшейся работы
2. Запусти quality gates (тесты, линтеры)
3. Обнови статус задач (bd)
4. **ОТПРАВЬ В REMOTE** — `git push` (обязательно!)
5. Очисти стеши и remote ветки
6. Проверь статус `git status` — должно быть "up to date with origin"
7. Предоставь контекст для следующей сессии

## Особые правила

### Безопасность

- ВСЕГДА сначала проверяй `docs/rules/security.md`
- Никогда не хардкоди секреты
- Всегда маскируй секреты в логах
- Если не уверен — спрашивай

### Git

- Не создавай коммиты без запроса пользователя
- Если пользователь просит создать коммит:
  - Запусти `git status`, `git diff`, `git log` параллельно
  - Анализируй изменения
  - Создай commit message по стилю проекта
  - Добавь файлы и создай commit
  - Запусти `git status` для проверки

### Тестирование

- Не запускай тесты, если пользователь не просит
- Если просит — найди правильную команду (npm test, make test, go test и т.д.)
- Не создавай файлы отчетов тестов

### Документация

- НЕ создавай файлы отчетов/заметок (REFACTORING_NOTES.md, CHANGELOG.md, NOTES.md и т.п.)
- Не создавай/не обновляй README.md без явного запроса

## Примеры взаимодействий

### ✅ Хорошо

**Пользователь:** "Добавь инструмент для работы с GitHub"

**Claude:**
- Читает `docs/rules/projectrules.md` и `docs/rules/architecture.md`
- Изучает существующие инструменты в `internal/tools/`
- Создает `internal/tools/github.go`
- Регистрирует в Registry
- Пишет unit тесты
- Уверенность: 85%

**Пользователь:** "Проверь безопасность проекта"

**Claude:**
- Читает `docs/rules/security.md`
- Запускает gitleaks scanning
- Проверяет переменные окружения
- Проверяет маскирование секретов
- Уверенность: 90%

### ❌ Плохо

**Пользователь:** "Добавь инструмент для работы с GitHub"

**Claude:**
- Создает файлы без чтения правил проекта
- Не следует архитектуре
- Не пишет тесты
- Не объясняет свои действия
- Уверенность: 60%

## Резюме

Claude:
1. Следует инструкциям из `AGENTS.md`
2. Приоритизирует безопасность над всем остальным
3. Использует lazy loading для `docs/rules/*.md`
4. Отвечает кратко и по делу
5. Завершает работу только после `git push`
